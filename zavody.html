<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Výsledky - zapisování</title>
<style>
    body { font-family: "Segoe UI", sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
    .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 25px; }
    
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 600px; margin: 0 auto; }
    .menu-btn { padding: 30px; font-size: 1.2em; cursor: pointer; border: 2px solid #3498db; background: white; border-radius: 10px; transition: 0.3s; font-weight: bold; }
    .menu-btn:hover { background: #3498db; color: white; }

    .zavodnik-input-row { 
        display: grid; 
        grid-template-columns: 2fr 80px 120px 100px 1fr 1fr 1fr 50px; 
        gap: 8px; align-items: center; padding: 10px; border-bottom: 1px solid #eee; 
    }
    .zavodnik-input-row.no-cat { grid-template-columns: 2fr 80px 100px 1fr 1fr 1fr 50px; }
    .zavodnik-input-row input, .zavodnik-input-row select { padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; }
    
    .header-row { font-weight: bold; background: #34495e; color: white; border-radius: 6px 6px 0 0; }
    .nr-label { color: #e74c3c; font-weight: bold; font-size: 0.8em; margin-left: 2px; }
    
    table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 14px; background: white; }
    th, td { border: 1px solid #dfe6e9; padding: 10px; text-align: center; }
    th { background: #2d3436; color: white; }
    
    .active-row { background: #fff3a0 !important; outline: 2px solid #f1c40f; }
    .good { background: #b6f2c2 !important; font-weight: bold; }
    .bad { background: #f6b0b0 !important; color: #c0392b; text-decoration: line-through; }
    .total-cell { background: #f8f9fa; font-weight: bold; }
    .gl-pts { display: block; font-size: 0.85em; color: #16a085; font-weight: bold; }
    
    .input-weight-error { background-color: #ffcccc !important; border: 2px solid #e74c3c !important; }
    
    .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .btn-green { background: #27ae60; color: white; }
    .btn-blue { background: #3498db; color: white; }
    .btn-red { background: #e74c3c; color: white; }
    .btn-gray { background: #95a5a6; color: white; }
    
    #timer { position: fixed; bottom: 20px; right: 20px; font-size: 38px; background: #000; color: #0f0; padding: 12px 25px; border-radius: 12px; font-family: monospace; border: 2px solid #333; z-index: 100; }
    .hidden { display: none !important; }
    .res-section { margin-top: 30px; border-top: 2px solid #34495e; padding-top: 10px; }
</style>
</head>
<body>

<div id="step1" class="card">
    <h2 style="text-align:center">Vyberte disciplínu</h2>
    <div class="menu-grid">
        <button class="menu-btn" onclick="selectDisc('trojboj')">Trojboj</button>
        <button class="menu-btn" onclick="selectDisc('bench')">Bench</button>
    </div>
</div>

<div id="step2" class="card hidden">
    <h2 id="disc-title" style="text-align:center"></h2>
    <div class="menu-grid">
        <button class="menu-btn" onclick="initApp('raw')">RAW</button>
        <button class="menu-btn" onclick="initApp('eq')">EQ</button>
    </div>
</div>

<div id="entry" class="card hidden">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 id="setup-summary"></h3>
        <button id="toggleCatBtn" class="btn btn-red" style="padding: 5px 10px; font-size: 12px;" onclick="toggleCategories()">Vypnout kategorie ✖</button>
    </div>
    <div id="competitor-header" class="zavodnik-input-row header-row">
        <div>Jméno</div><div>Pohl.</div><div class="cat-col">Kategorie</div><div>Váha (kg)</div><div class="sq-col">Dřep</div><div class="bp-col">Bench</div><div class="dl-col">Tah</div><div></div>
    </div>
    <div id="competitors-list"></div>
    <button class="btn btn-blue" style="margin-top:10px" onclick="addCompetitorRow()">➕ Přidat závodníka</button>
    <button class="btn btn-green" style="width: 100%; margin-top:20px; padding: 15px;" onclick="startCompetition()">▶ SPUSTIT SOUTĚŽ</button>
</div>

<div id="competition" class="hidden">
    <div id="tables-container"></div>
</div>

<div id="results" class="hidden card">
    <h1 style="text-align: center;">KONEČNÉ VÝSLEDKY</h1>
    <div id="results-content"></div>
    <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-gray" onclick="backToComp()">⬅ Zpět k opravě pokusů</button>
    </div>
</div>

<div id="timer" class="hidden">01:00</div>

<script>
let disc = "", equip = "", competitors = [], currentLift = "drep", activeIdx = 0, currentRound = 0, timerSec = 60;
let showCategories = true;

const CATEGORIES = { 
    m: ["-59", "-66", "-74", "-83", "-93", "-105", "-120", "120+"], 
    f: ["-43", "-47", "-52", "-57", "-63", "-69", "-76", "-84", "84+"] 
};

const GL_COEFFS = {
    trojboj: {
        raw: { m: { a: 1199.72839, b: 1025.18162, c: 0.00921 }, f: { a: 610.32796, b: 435.43223, c: 0.01657 } },
        eq: { m: { a: 1236.25115, b: 1049.93869, c: 0.00930 }, f: { a: 758.26475, b: 568.33271, c: 0.01491 } }
    },
    bench: {
        raw: { m: { a: 320.44458, b: 281.24073, c: 0.01898 }, f: { a: 221.82209, b: 194.01303, c: 0.02421 } },
        eq: { m: { a: 381.22073, b: 333.27375, c: 0.01906 }, f: { a: 278.83621, b: 236.45550, c: 0.02384 } }
    }
};

function selectDisc(d) {
    disc = d;
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
    document.getElementById('disc-title').innerText = d === 'trojboj' ? 'Disciplína: Trojboj' : 'Disciplína: Benchpress';
}

function initApp(e) {
    equip = e;
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('entry').classList.remove('hidden');
    document.getElementById('setup-summary').innerText = `${disc.toUpperCase()} - ${equip.toUpperCase()}`;
    currentLift = (disc === 'bench') ? 'bench' : 'drep';
    if(disc === 'bench') document.querySelectorAll('.sq-col, .dl-col').forEach(el => el.style.display = 'none');
    addCompetitorRow();
}

function toggleCategories() {
    showCategories = !showCategories;
    const btn = document.getElementById('toggleCatBtn');
    btn.innerText = showCategories ? "Vypnout kategorie ✖" : "Zapnout kategorie ✔";
    btn.classList.toggle('btn-red'); btn.classList.toggle('btn-green');
    document.getElementById('competitor-header').classList.toggle('no-cat');
    document.querySelectorAll('#competitors-list .zavodnik-input-row').forEach(r => {
        r.classList.toggle('no-cat');
        const catSel = r.querySelector('.cat');
        if(catSel) catSel.style.display = showCategories ? 'block' : 'none';
    });
}

function validateWeight(input) {
    if (!showCategories) { input.classList.remove('input-weight-error'); return; }
    const row = input.parentElement;
    const sex = row.querySelector('.sex').value;
    const bw = parseFloat(input.value) || 0;
    const cat = row.querySelector('.cat').value;
    const cats = CATEGORIES[sex];
    const idx = cats.indexOf(cat);
    let min = (idx > 0) ? parseFloat(cats[idx-1].replace('-','')) : 0;
    let isErr = cat.includes('+') ? (bw <= parseFloat(cat)) : (bw > parseFloat(cat.replace('-','')) || bw <= min);
    input.classList.toggle('input-weight-error', bw > 0 && isErr);
}

function addCompetitorRow() {
    const div = document.createElement("div");
    div.className = "zavodnik-input-row" + (showCategories ? "" : " no-cat");
    div.innerHTML = `
        <input class="name" placeholder="Jméno">
        <select class="sex" onchange="updateCat(this)"><option value="m">M</option><option value="f">Ž</option></select>
        <select class="cat" style="${showCategories?'':'display:none'}">${CATEGORIES.m.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
        <input type="number" class="bw" placeholder="kg" step="0.01" oninput="validateWeight(this)">
        <input type="number" class="sq" placeholder="kg" style="${disc==='bench'?'display:none':''}">
        <input type="number" class="bp" placeholder="kg">
        <input type="number" class="dl" placeholder="kg" style="${disc==='bench'?'display:none':''}">
        <button onclick="this.parentElement.remove()" style="border:none; color:red; background:none; cursor:pointer;">✖</button>
    `;
    document.getElementById('competitors-list').appendChild(div);
}

function updateCat(el) {
    const sex = el.value;
    const catSel = el.parentElement.querySelector('.cat');
    if(catSel) {
        catSel.innerHTML = CATEGORIES[sex].map(c => `<option value="${c}">${c}</option>`).join('');
        const bwInput = el.parentElement.querySelector('.bw');
        if(bwInput.value) validateWeight(bwInput);
    }
}

function calculateGL(comp, total) {
    if (total <= 0) return "0.0000";
    const c = GL_COEFFS[disc][equip][comp.sex];
    const denom = c.a - (c.b * Math.exp(-c.c * comp.bw));
    return (total * 100 / denom).toFixed(4);
}

function getBestLiftOrExpected(c, lift) {
    let best = 0; let attempted = false;
    for(let i=0; i<3; i++) {
        if(c.results[lift][i] !== null) {
            attempted = true;
            if(c.results[lift][i] === 'good' && c.lifts[lift][i] > best) best = c.lifts[lift][i];
        }
    }
    return (!attempted) ? c.lifts[lift][0] : best;
}

function getProgressiveTotal(c) {
    if(disc === 'bench') return getBestLiftOrExpected(c, 'bench');
    return getBestLiftOrExpected(c, 'drep') + getBestLiftOrExpected(c, 'bench') + getBestLiftOrExpected(c, 'tah');
}

function startCompetition() {
    const rows = document.querySelectorAll('#competitors-list .zavodnik-input-row');
    competitors = [];
    rows.forEach((row, index) => {
        competitors.push({
            id: index,
            name: row.querySelector('.name').value || `Závodník ${index+1}`,
            sex: row.querySelector('.sex').value,
            cat: showCategories ? row.querySelector('.cat').value : "Open",
            bw: parseFloat(row.querySelector('.bw').value) || 0,
            lifts: { 
                drep: [parseFloat(row.querySelector('.sq')?.value)||0, 0, 0],
                bench: [parseFloat(row.querySelector('.bp')?.value)||0, 0, 0],
                tah: [parseFloat(row.querySelector('.dl')?.value)||0, 0, 0]
            },
            isNR: { drep: [false,false,false], bench: [false,false,false], tah: [false,false,false] },
            results: { drep: [null,null,null], bench: [null,null,null], tah: [null,null,null] }
        });
    });
    document.getElementById('entry').classList.add('hidden');
    document.getElementById('competition').classList.remove('hidden');
    document.getElementById('timer').classList.remove('hidden');
    render();
    if(!window.timerInterval) window.timerInterval = setInterval(tick, 1000);
}

function render() {
    const container = document.getElementById('tables-container');
    container.innerHTML = "";
    const lifts = (disc === 'bench') ? ['bench'] : ['drep', 'bench', 'tah'];
    
    lifts.forEach(l => {
        const sorted = [...competitors].sort((a, b) => (a.lifts[l][currentRound] - b.lifts[l][currentRound]) || (a.id - b.id));
        let html = `<div class="card ${l !== currentLift ? 'inactive-table' : ''}"><h2>${l.toUpperCase()}</h2><table>
            <tr><th>Jméno</th><th>Váha</th><th>1. pokus</th><th>2. pokus</th><th>3. pokus</th><th>Total (GL)</th></tr>`;
        sorted.forEach((c, idx) => {
            const active = (l === currentLift && idx === activeIdx);
            const total = getProgressiveTotal(c);
            html += `<tr class="${active ? 'active-row' : ''}">
                <td>${c.name}</td><td>${c.bw}</td>
                ${[0,1,2].map(r => `<td class="${c.results[l][r] || ''}">
                    <input type="number" value="${c.lifts[l][r]}" onchange="updateVal('${l}',${c.id},${r},this.value)" style="width:50px">
                    <input type="checkbox" ${c.isNR[l][r]?'checked':''} onchange="updateNR('${l}',${c.id},${r},this.checked)"> ${c.isNR[l][r]?'<span class="nr-label">NR</span>':''}
                </td>`).join('')}
                <td class="total-cell">${total}kg<br><small>${calculateGL(c, total)} GL</small></td></tr>`;
        });
        html += `</table>`;
        if(l === currentLift) html += `<div class="controls"><button class="btn btn-green" onclick="judge('good')">GOOD</button> <button class="btn btn-red" onclick="judge('bad')">NO LIFT</button> <button class="btn btn-blue" onclick="next()">DALŠÍ</button></div>`;
        container.innerHTML += html + `</div>`;
    });
}

function updateVal(l, id, r, v) { competitors.find(c => c.id === id).lifts[l][r] = parseFloat(v); render(); }
function updateNR(l, id, r, v) { competitors.find(c => c.id === id).isNR[l][r] = v; render(); }

function judge(res) {
    const l = currentLift;
    const sorted = [...competitors].sort((a, b) => (a.lifts[l][currentRound] - b.lifts[l][currentRound]) || (a.id - b.id));
    const c = sorted[activeIdx];
    c.results[l][currentRound] = res;
    if(currentRound < 2 && c.lifts[l][currentRound+1] === 0) c.lifts[l][currentRound+1] = c.lifts[l][currentRound] + (res === 'good' ? 2.5 : 0);
    render();
}

function next() {
    activeIdx++;
    if(activeIdx >= competitors.length) {
        activeIdx = 0; currentRound++;
        if(currentRound > 2) {
            currentRound = 0;
            if(currentLift === 'drep') currentLift = 'bench';
            else if(currentLift === 'bench' && disc === 'trojboj') currentLift = 'tah';
            else finish();
        }
    }
    timerSec = 60; render();
}

function finish() {
    document.getElementById('competition').classList.add('hidden');
    document.getElementById('timer').classList.add('hidden');
    document.getElementById('results').classList.remove('hidden');
    
    let html = "";
    if(showCategories) {
        html += `<h2 class="res-section">POŘADÍ V KATEGORIÍCH</h2>`;
        // Seskupení podle pohlavi a kategorie
        const catKeys = [...new Set(competitors.map(c => JSON.stringify({sex: c.sex, cat: c.cat})))].sort();
        catKeys.forEach(keyJson => {
            const key = JSON.parse(keyJson);
            const filtered = competitors.filter(c => c.sex === key.sex && c.cat === key.cat);
            filtered.sort((a, b) => getProgressiveTotal(b) - getProgressiveTotal(a) || a.bw - b.bw);
            
            html += `<h3>${key.sex === 'm' ? 'Muži' : 'Ženy'} ${key.cat}</h3><table><tr><th>Poř.</th><th>Jméno</th><th>Total</th><th>GL Body</th></tr>`;
            filtered.forEach((c, i) => {
                const total = getProgressiveTotal(c);
                html += `<tr><td>${i+1}.</td><td>${c.name}</td><td>${total} kg</td><td>${calculateGL(c, total)}</td></tr>`;
            });
            html += `</table>`;
        });
    }

    html += `<h2 class="res-section">ABSOLUTNÍ POŘADÍ (IPF GL)</h2>`;
    ['m', 'f'].forEach(sex => {
        const filtered = competitors.filter(c => c.sex === sex);
        if(filtered.length > 0) {
            html += `<h3>${sex === 'm' ? 'MUŽI' : 'ŽENY'}</h3><table><tr><th>Poř.</th><th>Jméno</th><th>Kategorie</th><th>Total</th><th>GL Body</th></tr>`;
            filtered.sort((a, b) => calculateGL(b, getProgressiveTotal(b)) - calculateGL(a, getProgressiveTotal(a)));
            filtered.forEach((c, i) => {
                const total = getProgressiveTotal(c);
                html += `<tr><td>${i+1}.</td><td>${c.name}</td><td>${c.cat}</td><td>${total} kg</td><td><strong>${calculateGL(c, total)}</strong></td></tr>`;
            });
            html += `</table>`;
        }
    });
    
    document.getElementById('results-content').innerHTML = html;
}

function backToComp() {
    document.getElementById('results').classList.add('hidden');
    document.getElementById('competition').classList.remove('hidden');
    document.getElementById('timer').classList.remove('hidden');
}

function tick() { 
    if(timerSec > 0) timerSec--; 
    const m = Math.floor(timerSec/60), s = timerSec%60; 
    document.getElementById('timer').innerText = `${m}:${s.toString().padStart(2,'0')}`; 
}
</script>
</body>
</html>
